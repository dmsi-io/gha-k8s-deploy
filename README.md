# GHA Kubernetes Deploy

[![actions-workflow-main][actions-workflow-main-badge]][actions-workflow-main]
[![release][release-badge]][release]

The purpose of this GitHub Action is to handle the setup of GCloud and kubectl resources, docker building and publishing, as well as deployment of kubernetes objects.

## Inputs

| NAME                 | DESCRIPTION                                                                                      | TYPE     | REQUIRED | DEFAULT           |
| -------------------- | ------------------------------------------------------------------------------------------------ | -------- | -------- | ----------------- |
| `GCP_SA_KEY`         | GCP Service Account Key (JSON).                                                                  | `string` | `true`   |                   |
| `GKE_CLUSTER_NAME`   | Google Kubernetes Engine Cluster name.                                                           | `string` | `true`   |                   |
| `GCP_ZONE`           | GCP Zone.                                                                                        | `string` | `true`   |                   |
| `GCP_PROJECT_ID`     | GCP Project ID.                                                                                  | `string` | `true`   |                   |
| `print_gcloud_info`  | Flag to optionally print gcloud info after authenticating.                                       | `bool`   | `false`  | `false`           |
| `print_environment`  | Flag to optionally print environment variables.                                                  | `bool`   | `false`  | `false`           |
| `k8s_directory`      | Location of k8s config files.                                                                    | `string` | `false`  | `k8s`             |
| `namespace`          | Filename of namespace config.                                                                    | `string` | `false`  | `namespace.yaml`  |
| `secret`             | Name of secret to copy from default namespace.                                                   | `string` | `false`  |                   |
| `configmap`          | Filename of configmap config. (Can also be used for any other arbitrary K8S artifact to deploy). | `string` | `false`  | `configmap.yaml`  |
| `deployment`         | Filename of deployment config.                                                                   | `string` | `false`  | `deployment.yaml` |
| `service`            | Filename of service config.                                                                      | `string` | `false`  | `service.yaml`    |
| `ingress`            | Filename of ingress config.                                                                      | `string` | `false`  | `ingress.yaml`    |
| `skip_docker`        | Flag to skip docker build and push steps.                                                        | `bool`   | `false`  | `false`           |
| `docker_directory`   | Directory of Dockerfile.                                                                         | `string` | `false`  | `./`              |
| `skip_k8s_deploy`    | Flag to skip Kubernetes artifact deployment steps.                                               | `bool`   | `false`  | `false`           |
| `skip_deploy_status` | Flag to skip deployment status check.                                                            | `bool`   | `false`  | `false`           |

## Outputs

| NAME  | DESCRIPTION                                                                                                                                 | TYPE     |
| ----- | ------------------------------------------------------------------------------------------------------------------------------------------- | -------- |
| `url` | The namespace URL generated by the deployment process. Will be an empty string if k8s deploy is skipped or no namespace config is provided. | `string` |

## Example

```yaml
- name: Checkout
  uses: actions/checkout@v2

- name: Export Environment Variables
  uses: dmsi-io/gha-env-variables@v1
  with:
    TLD: ${{ secrets.TOP_LEVEL_DOMAIN }}
    GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

- name: Deploy Kubernetes
  uses: dmsi-io/gha-k8s-deploy@v1.1
  with:
    GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
    GKE_CLUSTER_NAME: ${{ secrets.GCP_STAGING_CLUSTER_NAME }}
    GCP_ZONE: ${{ secrets.GCP_ZONE }}
    GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
```

For a further practical example, see [.github/workflows/main.yml](.github/workflows/main.yml).

<!-- badge links -->

[actions-workflow-main]: https://github.com/dmsi-io/gha-k8s-deploy/actions/query?workflow%3ATest%2gha-k8s-deploy
[actions-workflow-main-badge]: https://img.shields.io/github/workflow/status/dmsi-io/gha-k8s-deploy/Test%20gha-k8s-deploy?label=Test%20gha-k8s-deploy&style=for-the-badge&logo=github
[release]: https://github.com/dmsi-io/gha-k8s-deploy/releases
[release-badge]: https://img.shields.io/github/v/release/dmsi-io/gha-k8s-deploy?style=for-the-badge&logo=github
